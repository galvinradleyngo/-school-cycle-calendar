<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gotten to Know You Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 24px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">
            <div class="text-center">
                <h1 class="text-4xl font-bold mb-4">🎮 Gotten to Know You!</h1>
                <div class="flex items-center justify-center">
                    <p class="text-xl">Loading game...</p>
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        console.log('🎮 Game script starting - CLEAN VERSION 3.1 - NO LEGACY CODE...');
        console.log('🕐 Loaded at:', new Date().toISOString());
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDU32POTx2DzJoijpyMiv-yZHRJQAH1foA",
            authDomain: "gotten-to-know-you.firebaseapp.com",
            databaseURL: "https://gotten-to-know-you-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "gotten-to-know-you",
            storageBucket: "gotten-to-know-you.firebasestorage.app",
            messagingSenderId: "553283770730",
            appId: "1:553283770730:web:41c81f52de885116b0ed13"
        };
        
        // Game state variables
        let gameState = 'menu';
        let gameCode = '';
        let playerName = '';
        let currentGame = null;
        let gameQuestions = [];
        let currentQuestion = 0;
        let score = 0;
        let timeLeft = 15;
        let timerInterval = null;
        let pollInterval = null;
        let gameDatabase = {};
        let isFirebaseAvailable = true;
        
        // CLEAN Firebase operations
        async function saveGameToFirebase(code, data) {
            console.log('🔥 SAVING to Firebase:', code);
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/games/${code}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    console.log('✅ Successfully saved to Firebase');
                    return true;
                } else {
                    console.log('❌ Firebase save failed:', response.status);
                    return false;
                }
            } catch (error) {
                console.log('❌ Firebase save error:', error.message);
                return false;
            }
        }
        
        async function loadGameFromFirebase(code) {
            console.log('🔍 LOADING from Firebase:', code);
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/games/${code}.json`);
                console.log('📡 Firebase response status:', response.status, response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('📦 Firebase returned:', data);
                    
                    // If we got actual data (not null), return it
                    if (data !== null && typeof data === 'object') {
                        console.log('✅ FOUND game in Firebase!');
                        // Ensure it has a code property
                        if (!data.code) {
                            data.code = code;
                        }
                        return data;
                    } else {
                        console.log('❌ Firebase returned null (game does not exist)');
                    }
                }
            } catch (error) {
                console.log('❌ Firebase load error:', error.message);
            }
            return null;
        }
        
        // Utility functions
        function generateGameCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }
        
        function showError(elementId, message) {
            console.log('🚨 Error:', message);
            const errorEl = document.getElementById(elementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
                setTimeout(() => {
                    if (errorEl) errorEl.classList.add('hidden');
                }, 8000);
            } else {
                alert('Error: ' + message);
            }
        }
        
        // Render main menu
        function renderMenu() {
            console.log('🏠 Rendering main menu');
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-purple-600 via-pink-600 to-blue-600 flex items-center justify-center p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="mb-8">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 text-4xl">
                                👥
                            </div>
                            <h1 class="text-3xl font-bold text-gray-800 mb-2">Gotten to Know You!</h1>
                            <p class="text-gray-600">A fun classroom game to learn about each other</p>
                        </div>
                        
                        <div class="space-y-4">
                            <button onclick="startTeacherFlow()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                🎓 I'm a Teacher
                            </button>
                            
                            <button onclick="startStudentFlow()" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                🎒 I'm a Student
                            </button>
                            
                            <button onclick="testFirebaseConnection()" class="w-full bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white font-semibold py-3 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg text-sm">
                                🔥 Test Firebase
                            </button>
                        </div>
                        
                        <div class="mt-6 text-xs text-gray-500">
                            v3.0 - Clean Firebase Edition
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Teacher flow
        function startTeacherFlow() {
            console.log('👨‍🏫 Starting teacher flow');
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 flex items-center justify-center p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Create New Game</h2>
                        <p class="text-gray-600 mb-8">Click below to create a new game and get your game code!</p>
                        
                        <button onclick="createGame()" class="w-full bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg mb-4">
                            🎮 Create Game
                        </button>
                        
                        <button onclick="renderMenu()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-2xl transition-all duration-300">
                            ← Back to Menu
                        </button>
                        
                        <div id="create-error" class="hidden mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl"></div>
                    </div>
                </div>
            `;
        }
        
        async function createGame() {
            console.log('🎯 Creating new game...');
            
            // Generate game code
            gameCode = generateGameCode();
            console.log('Generated code:', gameCode);
            
            // Create game object
            currentGame = {
                code: gameCode,
                players: [],
                isStarted: false,
                gamePhase: 'waiting',
                createdAt: new Date().toISOString(),
                createdBy: 'teacher'
            };
            
            // Save to Firebase
            const saved = await saveGameToFirebase(gameCode, currentGame);
            if (saved) {
                // Verify by loading back
                const verification = await loadGameFromFirebase(gameCode);
                if (verification) {
                    console.log('✅ Game created and verified!');
                    showTeacherDashboard();
                } else {
                    console.log('❌ Game creation verification failed');
                    showError('create-error', 'Failed to verify game creation');
                }
            } else {
                showError('create-error', 'Failed to create game');
            }
        }
        
        function showTeacherDashboard() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-pink-600 p-4 fade-in">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white rounded-3xl shadow-2xl p-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-gray-800 mb-4">Teacher Dashboard</h2>
                                <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white px-6 py-3 rounded-2xl inline-block text-xl font-bold mb-4">
                                    Game Code: ${gameCode}
                                </div>
                                
                                <div class="bg-green-100 border border-green-400 text-green-800 px-4 py-2 rounded-2xl mb-4">
                                    ✅ Game Active - Students can join now!
                                </div>
                                
                                <div class="mt-6 bg-blue-100 border border-blue-400 text-blue-800 px-4 py-3 rounded-2xl">
                                    <strong>📱 Students join at: galvinradleyngo.github.io/gotten-to-know-you-game/</strong>
                                    <br />
                                    <div class="mt-3 space-x-2">
                                        <button onclick="copyInstructions()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold">
                                            📋 Copy Instructions
                                        </button>
                                        <button onclick="copyGameLink()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg font-semibold">
                                            🔗 Copy Game Link
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center">
                                <p class="text-lg text-gray-600 mb-4">Game created successfully!</p>
                                <p class="text-sm text-gray-500">Students can now join using code: <strong>${gameCode}</strong></p>
                                
                                <button onclick="renderMenu()" class="mt-6 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-2xl transition-all duration-300">
                                    ← Back to Menu
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Student flow
        function startStudentFlow() {
            console.log('👨‍🎓 Starting student flow');
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-600 via-teal-600 to-blue-600 flex items-center justify-center p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6">Join Game</h2>
                        
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Game Code</label>
                                <input type="text" id="game-code-input" placeholder="Enter game code" class="w-full px-4 py-3 border-2 border-gray-300 rounded-2xl focus:border-blue-500 focus:outline-none text-center text-lg font-semibold uppercase" maxlength="6">
                            </div>
                            
                            <button onclick="joinGame()" class="w-full bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white font-semibold py-4 px-6 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                                🎯 Join Game
                            </button>
                            
                            <div id="join-error" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-2xl"></div>
                        </div>
                        
                        <button onclick="renderMenu()" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-2xl transition-all duration-300 mt-4">
                            ← Back to Menu
                        </button>
                    </div>
                </div>
            `;
            
            // Auto-uppercase input
            document.getElementById('game-code-input').addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
        }
        
        async function joinGame() {
            console.log('🎯 CLEAN VERSION - Attempting to join game...');
            const codeInput = document.getElementById('game-code-input');
            const code = codeInput ? codeInput.value.toUpperCase().trim() : '';
            
            console.log('Input code:', code);
            
            if (!code) {
                showError('join-error', 'Please enter a game code');
                return;
            }
            
            if (code.length !== 6) {
                showError('join-error', 'Game code must be 6 characters long');
                return;
            }
            
            console.log('🔍 Searching for game:', code);
            
            try {
                // Direct Firebase check with detailed logging
                console.log('Making Firebase request...');
                const url = `${firebaseConfig.databaseURL}/games/${code}.json`;
                console.log('URL:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Response data:', data);
                    console.log('Data type:', typeof data);
                    console.log('Data is null:', data === null);
                    
                    if (data !== null) {
                        console.log('✅ SUCCESS! Game found in Firebase');
                        console.log('Game data:', JSON.stringify(data, null, 2));
                        
                        // Success!
                        gameCode = code;
                        currentGame = data;
                        showJoinSuccess();
                        return;
                    } else {
                        console.log('❌ Firebase returned null (game does not exist)');
                    }
                } else {
                    console.log('❌ Firebase request failed:', response.status, response.statusText);
                }
                
                // If we get here, game was not found
                console.log('❌ Game not found');
                showError('join-error', 'Game not found! Please check the code and try again.');
                
            } catch (error) {
                console.error('❌ Error during join:', error);
                showError('join-error', 'Error joining game: ' + error.message);
            }
        }
        
        function showJoinSuccess() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-600 via-teal-600 to-blue-600 flex items-center justify-center p-4 fade-in">
                    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full text-center">
                        <div class="text-6xl mb-4 animate-bounce">🎉</div>
                        <h2 class="text-3xl font-bold text-gray-800 mb-4">Success!</h2>
                        <p class="text-lg text-gray-600 mb-6">You've successfully joined the game!</p>
                        <p class="text-sm text-gray-500 mb-6">Game Code: <strong>${gameCode}</strong></p>
                        <p class="text-sm text-gray-500">Multi-device joining is working! 🔥</p>
                        
                        <button onclick="renderMenu()" class="mt-6 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold py-4 px-8 rounded-2xl transition-all duration-300 transform hover:scale-105 shadow-lg">
                            🏠 Back to Menu
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            console.log('🧪 Testing Firebase connection...');
            try {
                // Test basic connection
                const testResponse = await fetch(`${firebaseConfig.databaseURL}/.json`);
                console.log('Basic connection:', testResponse.ok);
                
                // Test games endpoint
                const gamesResponse = await fetch(`${firebaseConfig.databaseURL}/games.json`);
                const gamesData = await gamesResponse.json();
                console.log('Games in Firebase:', gamesData ? Object.keys(gamesData) : 'None');
                
                if (testResponse.ok && gamesResponse.ok) {
                    alert(`✅ Firebase is working!\n\nGames found: ${gamesData ? Object.keys(gamesData).length : 0}\nCodes: ${gamesData ? Object.keys(gamesData).join(', ') : 'None'}`);
                } else {
                    alert('❌ Firebase test failed!');
                }
            } catch (error) {
                console.error('Firebase test error:', error);
                alert('❌ Firebase test failed: ' + error.message);
            }
        }
        
        // Global functions for onclick handlers
        window.startTeacherFlow = startTeacherFlow;
        window.startStudentFlow = startStudentFlow;
        window.testFirebaseConnection = testFirebaseConnection;
        window.createGame = createGame;
        window.joinGame = joinGame;
        window.renderMenu = renderMenu;
        
        window.copyInstructions = function() {
            const message = `🎮 Join our class game!\n\n1. Go to: https://galvinradleyngo.github.io/gotten-to-know-you-game/\n2. Click "I'm a Student"\n3. Enter code: ${gameCode}`;
            navigator.clipboard.writeText(message).then(() => {
                alert('✅ Instructions copied to clipboard!');
            });
        };
        
        window.copyGameLink = function() {
            const link = `https://galvinradleyngo.github.io/gotten-to-know-you-game/?code=${gameCode}`;
            navigator.clipboard.writeText(link).then(() => {
                alert('✅ Game link copied to clipboard!');
            });
        };
        
        // Initialize the game
        async function init() {
            console.log('🚀 Initializing clean Firebase game...');
            
            // Test Firebase connectivity
            try {
                const response = await fetch(`${firebaseConfig.databaseURL}/.json`);
                isFirebaseAvailable = response.ok;
                console.log('Firebase available:', isFirebaseAvailable);
            } catch (error) {
                console.log('Firebase unavailable:', error.message);
                isFirebaseAvailable = false;
            }
            
            // Check for game code in URL
            const urlParams = new URLSearchParams(window.location.search);
            const codeParam = urlParams.get('code');
            
            if (codeParam) {
                console.log('Found game code in URL:', codeParam);
                gameCode = codeParam.toUpperCase();
                // Auto-start student flow with pre-filled code
                setTimeout(() => {
                    startStudentFlow();
                    setTimeout(() => {
                        const input = document.getElementById('game-code-input');
                        if (input) {
                            input.value = gameCode;
                        }
                    }, 100);
                }, 100);
            } else {
                // Start with menu
                setTimeout(() => {
                    renderMenu();
                }, 500);
            }
        }
        
        // Start the game
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
